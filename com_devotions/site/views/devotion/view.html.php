<?php defined('_JEXEC') or die('Restricted access');jimport('joomla.application.component.view');class DevotionsViewDevotion extends JView {    function display ($tpl = null) {        $id = JRequest::getVar('dId', 0, 'get', 'int');        $model =& $this->getModel();        $jUser = &JFactory::getUser();                $devotion = $model->getDevotion($id);        $pastor = $model->getPastor($devotion->pastor);        $devotions = $model->getRecentDevotions($pastor->id);        $user = $model->getUser($jUser->id);        $blessings = $model->getBlessings($id);        $comments = $this->getComments($id, $model);        $commentForm = $this->getCommentForm($id, $user, $pastor);                $this->assignRef('model', $model);        $this->assignRef('pastor', $pastor);        $this->assignRef('user', $user);        $this->assignRef('devotion', $devotion);        $this->assignRef('devotions', $devotions);        $this->assignRef('comments', $comments);        $this->assignRef('commentForm', $commentForm);        $this->assignRef('blessings', $blessings);        $this->assignRef('devotionId', $id);                parent::display($tpl);    }                function getCommentForm($devotionId, $user, $pastor) {        $html = "<div style=\"height: 5px; margin: 10px 0px 15px 0px; background: url('templates/vt_create/images/h3.gif') repeat-x;\"> &nbsp; </div>";                $html .= '<h1 style="font-size:140%">Child of God, what have you learnt from this devotion???</h1>';        $html .= '<h1 style="font-size:140%; margin-bottom: 10px; margin-top: 5px">';        $html .= '<a href="' . JRoute::_('index.php?option=com_devotions&view=profile&Itemid=6&pid=' . $pastor->id) . '">';        $html .= $pastor->name . '</a> would love to know.</h1>';                $html .= '<form name="commentForm" action="index.php" method="post" />';        $html .= '<p><label for="comment" style="font-weight: normal">Comment: <span class="red">*</span></label> <br>';        $html .= '<textarea style="border: 1px solid #07A0AD" cols="30" rows="5" name="comment"></textarea></p>';        $html .= '<p><input type="hidden"  name="name" value="' . $user->name . '" />';        $html .= '<input type="hidden"  name="userid" value="' . $user->userid . '" />';        $html .= '<input type="hidden"  name="devotionid" value="' . $devotionId . '" />';        $html .= '<input type="hidden"  name="option" value="com_devotions" />';        $html .= '<input type="hidden"  name="task" value="comment" />';        $html .= JHTML::_( 'form.token' );        $html .= '<input type="submit" class="button white" name="submit" value="Share" /></p>';        $html .= '</form>';                return $html;    }                    function getComments($devotionId, &$model) {        $comments = $model->getComments($devotionId);                if(!is_array($comments) || !count($comments) > 0) {            return '';        }                $pagination = $model->getPagination($devotionId);        $paginationDiv = '<div style="margin-left: 5px; margin-top: 10px; margin-bottom: 10px;">';                $paginationDiv .= '<form action="index.php?option=com_devotions&view=devotion&Itemid=6&dId=' . $devotionId . '" method="post" name="myform">';        $paginationDiv .= 'Display # ' . $pagination->getLimitBox() . '</form></div>';                $commentsDiv = '<div id="dcomments">';                foreach($comments as $comment) {             $p = '<p>';            $usr = $model->getUser($comment->userid);             $link = '<a href="' . JRoute::_('index.php?option=com_devotions&view=profile&Itemid=6&pid=' . $usr->id) . '" style="color:#444444">';            $nam = $usr->name ? $usr->name : $comment->full_name;            $p .= $link . '<img src="' . JURI::base() . "components/com_devotions/files/users/{$usr->url}\" onerror=\"this.src='/components/com_devotions/files/blank.png';\" class=\"pastor_img\" alt=\"{$nam}\" style=\"border-radius: 3px; -moz-border-radius: 3px; -webkit-border-radius: 3px; width: 64px; height: 64px; margin-right: 10px; float: left;\" title=\"{$nam}\" /></a>";            $p .= '<h3 style="margin-top: -5px">' . $link . $nam . '</a></h3>';            $p .= '<small>' . JHTML::Date($comment->ts) . '</small><br />';            $p .= '<span style="color: #07A0AD; line-height: 1.5em">' . $comment->comment_text . '</span>';            $p .= '</p>';            $p  .= '<p style="height:1px; clear:both;"> &nbsp; </p>';                        $commentsDiv .= $p;         }                $commentsDiv = $paginationDiv . $commentsDiv;                $commentsDiv .= '<div>' . $pagination->getPagesLinks() . '</div>';        $commentsDiv .= '</div>';                return $commentsDiv;    }}